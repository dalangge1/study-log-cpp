<!DOCTYPE html>

<script type="module">
  async function init() {
    const { instance } = await WebAssembly.instantiateStreaming(
      fetch('../dist/simd.wasm'),
    );
    const jsArrayA = [1, 2, 3, 4];
    const jsArrayB = [4, 3, 2, 1];

    // Allocate memory for 4 32-bit integers
    // and return get starting address.
    const cArrayPointerA = instance.exports._Z6mallocj(jsArrayA.length * 4);
    const cArrayPointerB = instance.exports._Z6mallocj(jsArrayA.length * 4);
    const cArrayPointerOut = instance.exports._Z6mallocj(jsArrayA.length * 4);

    // Turn that sequence of 32-bit integers
    // into a Int32Array, starting at that address.
    const cArrayA = new Int32Array(
      instance.exports.memory.buffer,
      cArrayPointerA,
      jsArrayA.length,
    );
    const cArrayB = new Int32Array(
      instance.exports.memory.buffer,
      cArrayPointerB,
      jsArrayA.length,
    );
    const cArrayOut = new Int32Array(
      instance.exports.memory.buffer,
      cArrayPointerOut,
      jsArrayA.length,
    );

    // Copy the values from JS to C.
    cArrayA.set(jsArrayA);
    cArrayB.set(jsArrayB);
    console.log(cArrayPointerA, cArrayPointerB, cArrayPointerOut);
    // Run the function, passing the starting address and length.
    instance.exports._Z15multiply_arraysPiS_S_i(
      cArrayPointerOut,
      cArrayPointerA,
      cArrayPointerB,
      jsArrayA.length,
    );
    console.log(cArrayOut);
    instance.exports._Z23multiply_arrays_no_simdPiS_S_i(
      cArrayPointerOut,
      cArrayPointerA,
      cArrayPointerB,
      jsArrayA.length,
    );
    console.log(cArrayOut);

  }
  init();
</script>
